<div class="page">
  <div class="page-header">
    <h1 class="page-title">Propostas</h1>
    <app-breadcrumb></app-breadcrumb>
  </div>

  <!-- Stats Cards -->
  <app-proposal-stats-cards
    [filteredProposals]="filteredProposals"
    [useFilteredData]="true"
    [activeStatusFilter]="filters.status">
  </app-proposal-stats-cards>

  <div class="table-container">
    <!-- Filters and Actions -->
    <div class="table-header">
      <div class="filters-section">
        <!-- All Filters in One Row -->
        <div class="filter-row">
          <!-- Search Box -->
          <div class="search-box" [class.searching]="isSearching">
            <i class="fas fa-search search-icon" *ngIf="!isSearching"></i>
            <i class="fas fa-spinner fa-spin search-icon" *ngIf="isSearching"></i>
            <input
              type="text"
              class="search-input"
              placeholder="Buscar por número da proposta ou nome do cliente..."
              [(ngModel)]="filters.search"
              (input)="onSearchInput()"
              [disabled]="isLoading && !isSearching">
            <button
              *ngIf="filters.search"
              class="clear-search-btn"
              (click)="clearSearch()"
              title="Limpar busca">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <!-- Status Filter -->
          <div class="filter-item">
            <label class="filter-label">
              <i class="fas fa-flag"></i>
              Status
            </label>
            <select class="filter-select" [(ngModel)]="filters.status" (change)="applyFilters()">
              <option value="">Todos</option>
              <option value="draft">Rascunho</option>
              <option value="sent">Enviada</option>
              <option value="signed">Fechada</option>
              <option value="rejected">Rejeitada</option>
              <option value="expired">Expirada</option>
              <option value="converted">Assinada</option>
              <option value="contraproposta">Assinada Parcialmente</option>
            </select>
          </div>

          <!-- Client Filter -->
          <div class="filter-item">
            <label class="filter-label">
              <i class="fas fa-user-tie"></i>
              Cliente
            </label>
            <select class="filter-select client-select" [(ngModel)]="filters.client_id" (change)="applyFilters()">
              <option [value]="null">Todos</option>
              <option *ngFor="let client of clients" [value]="client.id">{{ client.name }}</option>
            </select>
          </div>

          <!-- Type Filter -->
          <div class="filter-item">
            <label class="filter-label">
              <i class="fas fa-file-alt"></i>
              Tipo
            </label>
            <select class="filter-select" [(ngModel)]="filters.type" (change)="applyFilters()">
              <option value="">Todos</option>
              <option value="Full">Full</option>
              <option value="Pontual">Pontual</option>
              <option value="Individual">Individual</option>
              <option value="Recrutamento & Seleção">Recrutamento & Seleção</option>
            </select>
          </div>

          <!-- Month Filter -->
          <div class="filter-item">
            <label class="filter-label">
              <i class="fas fa-calendar-check"></i>
              Mês
            </label>
            <select class="filter-select month-select" [(ngModel)]="filters.month" (change)="applyFilters()">
              <option value="">Todos</option>
              <option value="1">Janeiro</option>
              <option value="2">Fevereiro</option>
              <option value="3">Março</option>
              <option value="4">Abril</option>
              <option value="5">Maio</option>
              <option value="6">Junho</option>
              <option value="7">Julho</option>
              <option value="8">Agosto</option>
              <option value="9">Setembro</option>
              <option value="10">Outubro</option>
              <option value="11">Novembro</option>
              <option value="12">Dezembro</option>
            </select>
          </div>

          <!-- Year Filter -->
          <div class="filter-item">
            <label class="filter-label">
              <i class="fas fa-calendar"></i>
              Ano
            </label>
            <select class="filter-select year-select" [(ngModel)]="filters.year" (change)="applyFilters()">
              <option value="">Todos</option>
              <option *ngFor="let year of availableYears" [value]="year">{{ year }}</option>
            </select>
          </div>

          <!-- Active Filters Indicator -->
          <div class="active-filters" *ngIf="getActiveFiltersCount() > 0">
            <span class="active-filters-badge">
              {{ getActiveFiltersCount() }} filtro{{ getActiveFiltersCount() > 1 ? 's' : '' }} ativo{{ getActiveFiltersCount() > 1 ? 's' : '' }}
            </span>
            <button class="btn-clear-inline" (click)="clearFilters()" title="Limpar todos os filtros">
              <i class="fas fa-times-circle"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Action Button -->
      <div class="action-buttons">
        <button class="btn btn-primary" (click)="openNewProposalPage()">
          <i class="fas fa-plus"></i>
          Nova Proposta
        </button>
      </div>
    </div>

    <!-- Mensagem de erro -->
    <div *ngIf="error" class="error-message">
      <i class="fas fa-exclamation-circle"></i>
      {{ error }}
    </div>

    <!-- Loading -->
    <div *ngIf="isLoading" class="loading-container">
      <i class="fas fa-spinner fa-spin"></i>
      Carregando propostas...
    </div>

    <!-- Tabela -->
    <div class="table-wrapper" *ngIf="!isLoading">
      <!-- Mensagem quando não há propostas -->
      <div *ngIf="filteredProposals.length === 0 && !error" class="empty-state">
        <i class="fas fa-file-alt empty-icon"></i>
        <h3>Nenhuma proposta encontrada</h3>
        <p>{{ filters.search || filters.status || filters.client_id || filters.type || filters.month || filters.year ? 'Tente ajustar os filtros de busca.' : 'Clique no botão "Nova Proposta" para adicionar a primeira proposta.' }}</p>
      </div>

      <!-- Tabela de propostas -->
      <table class="custom-table" *ngIf="filteredProposals.length > 0">
        <thead>
          <tr>
            <th class="sortable" (click)="sortBy('proposalNumber')">
              Número da Proposta
              <i [class]="getSortIcon('proposalNumber')"></i>
            </th>
            <th class="sortable" (click)="sortBy('clientName')">
              Cliente
              <i [class]="getSortIcon('clientName')"></i>
            </th>
            <th>Tipo</th>
            <th>Status</th>
            <th class="sortable" (click)="sortBy('totalValue')">
              Valor Total
              <i [class]="getSortIcon('totalValue')"></i>
            </th>
            <th class="sortable" (click)="sortBy('sla')">
              SLA
              <i [class]="getSortIcon('sla')"></i>
            </th>
            <th>Validade</th>
            <th>Criada em</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let proposal of filteredProposals"
            class="clickable"
            [class.expired]="proposal.isExpired && proposal.status !== 'signed'"
            (click)="viewProposal(proposal.id)"
          >
            <td>
              <div class="proposal-info">
                <div class="proposal-icon" [class.expired]="proposal.isExpired && proposal.status !== 'signed'">
                  <i class="fas fa-file-alt"></i>
                </div>
                <span class="proposal-number" [class.expired]="proposal.isExpired && proposal.status !== 'signed'">
                  {{ proposal.proposalNumber }}
                </span>
              </div>
            </td>

            <td>
              <div class="client-name-container">
                <span class="client-name">{{ proposal.clientName }}</span>
                <span class="client-company-name" *ngIf="proposal.clientType === 'PJ' && proposal.companyName && proposal.tradeName && proposal.tradeName !== proposal.companyName">
                  {{ proposal.companyName }}
                </span>
              </div>
            </td>

            <td>
              <span class="type-badge">{{ getProposalTypeText(proposal.raw.type) }}</span>
            </td>

            <td (click)="$event.stopPropagation()">
              <select
                class="status-select"
                [(ngModel)]="proposal.status"
                (change)="updateProposalStatus(proposal, $event)"
                [style.background-color]="getStatusColor(proposal.status)"
              >
                <option value="draft">Rascunho</option>
                <option value="sent">Enviada</option>
                <option value="signed">Fechada</option>
                <option value="rejected">Rejeitada</option>
                <option value="expired">Expirada</option>
                <option value="converted">Assinada</option>
                <option value="contraproposta">Assinada Parcialmente</option>
              </select>
            </td>
            <td>
              <span class="value-amount">{{ proposal.totalValue }}</span>
            </td>
            <td>
              <span
                class="sla-badge"
                [ngClass]="getSLAClass(proposal.sla)"
                *ngIf="proposal.sla !== '-'">
                {{ proposal.sla }}
              </span>
              <span class="sla-empty" *ngIf="proposal.sla === '-'">-</span>
            </td>
            <td>
              <span class="validity-date">{{ proposal.validUntil }}</span>
            </td>
            <td>
              <span class="created-date">{{ proposal.createdAt }}</span>
            </td>
            <td>
              <div class="action-buttons">
                <!-- Botão de Link Público/Gerar Link - condicional -->
                <button
                  *ngIf="proposal.raw.status === 'draft'"
                  class="action-btn generate-link-btn"
                  (click)="generatePublicLink(proposal, $event)"
                  title="Gerar Link Público"
                >
                  <i class="fas fa-external-link-alt"></i>
                </button>
                <button
                  *ngIf="proposal.raw.status === 'sent' || proposal.raw.status === 'signed' || proposal.raw.status === 'rejected' || proposal.raw.status === 'converted'"
                  class="action-btn link-btn"
                  (click)="copyPublicLink(proposal, $event)"
                  title="Copiar Link Público"
                >
                  <i class="fas fa-link"></i>
                </button>

                <!-- Botão Converter em Contrato - para propostas assinadas ou assinadas parcialmente -->
                <button
                  *ngIf="proposal.raw.status === 'signed' || proposal.raw.status === 'contraproposta'"
                  class="action-btn convert-btn"
                  (click)="convertToContract(proposal, $event)"
                  title="Converter em Contrato"
                >
                  <i class="fas fa-file-contract"></i>
                </button>

                <!-- Dropdown Menu com 3 pontos -->
                <div class="dropdown" [class.open]="proposal.id === activeDropdownId">
                  <button
                    class="action-btn dropdown-btn"
                    (click)="toggleDropdown(proposal.id, $event)"
                    title="Mais ações"
                  >
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" *ngIf="proposal.id === activeDropdownId">
                    <!-- Editar - só se não estiver assinada -->
                    <button
                      *ngIf="proposal.raw.status !== 'signed' && proposal.raw.status !== 'converted'"
                      class="dropdown-item"
                      (click)="editProposal(proposal.id); closeDropdown()"
                    >
                      <i class="fas fa-edit"></i>
                      <span>Editar</span>
                    </button>
                    
                    <!-- Duplicar -->
                    <button
                      class="dropdown-item"
                      (click)="duplicateProposal(proposal, $event); closeDropdown()"
                    >
                      <i class="fas fa-copy"></i>
                      <span>Duplicar</span>
                    </button>

                    <!-- Gerar PDF -->
                    <button
                      class="dropdown-item"
                      (click)="generatePDF(proposal, $event); closeDropdown()"
                    >
                      <i class="fas fa-file-pdf"></i>
                      <span>Gerar PDF</span>
                    </button>

                    <!-- Excluir -->
                    <button
                      class="dropdown-item delete-item"
                      (click)="deleteProposal(proposal, $event); closeDropdown()"
                    >
                      <i class="fas fa-trash"></i>
                      <span>Excluir</span>
                    </button>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Send Proposal Modal -->
<app-send-proposal-modal
  [proposal]="selectedProposalForSending"
  [isVisible]="showSendModal"
  (onClose)="onSendModalClose()"
  (onProposalSent)="onProposalSent($event)">
</app-send-proposal-modal>

<!-- Delete Confirmation Modal -->
<app-delete-confirmation-modal
  [isVisible]="showDeleteModal"
  [title]="'Confirmar Exclusão de Proposta'"
  [message]="'Tem certeza que deseja excluir esta proposta? Esta ação não pode ser desfeita.'"
  [itemName]="selectedProposalForDeletion ? selectedProposalForDeletion.proposalNumber + ' - ' + selectedProposalForDeletion.clientName : ''"
  [isDeleting]="isDeleting"
  [deleteButtonText]="'Excluir Proposta'"
  (onConfirm)="confirmDeleteProposal()"
  (onCancel)="cancelDeleteProposal()">
</app-delete-confirmation-modal>

<!-- Convert to Contract Modal -->
<app-proposal-to-contract-modal
  [isOpen]="showConvertModal"
  [proposal]="selectedProposalForConversion"
  (close)="closeConvertModal()"
  (converted)="onConversionCompleted($event)">
</app-proposal-to-contract-modal>

<!-- Duplicate Proposal Modal -->
<app-duplicate-proposal-modal
  [proposal]="selectedProposalForDuplication"
  [show]="showDuplicateModal"
  (close)="onDuplicateModalClose()"
  (proposalDuplicated)="onProposalDuplicated($event)">
</app-duplicate-proposal-modal>